# Codex assistant workflow
# Responds to @codex mentions in comments and reviews using the Codex CLI
# Supports inline review comments when performing code reviews

name: Codex

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

permissions: {}

concurrency:
  group: codex-${{ github.event.issue.number || github.event.pull_request.number || github.run_id }}
  cancel-in-progress: false

jobs:
  codex:
    if: |
      (
        github.event_name == 'issue_comment' &&
        contains(github.event.comment.body, '@codex') &&
        contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.comment.author_association)
      ) || (
        github.event_name == 'pull_request_review_comment' &&
        contains(github.event.comment.body, '@codex') &&
        contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.comment.author_association)
      ) || (
        github.event_name == 'pull_request_review' &&
        contains(github.event.review.body, '@codex') &&
        contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.review.author_association)
      )
    runs-on: ubuntu-24.04

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    env:
      ISSUE_NUMBER: ${{ github.event.issue.number || github.event.pull_request.number }}
      REPOSITORY: ${{ github.repository }}
      ACTOR: ${{ github.actor }}
      EVENT_NAME: ${{ github.event_name }}

    steps:
      - name: Mint identity token
        id: mint_identity_token
        if: vars.CODEX_APP_ID
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        with:
          app-id: ${{ vars.CODEX_APP_ID }}
          private-key: ${{ secrets.CODEX_PRIVATE_KEY }}
          permission-contents: read
          permission-issues: write
          permission-pull-requests: write

      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          token: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
          fetch-depth: 0

      - name: Get PR info
        id: pr_info
        env:
          GH_TOKEN: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
        run: |
          if gh pr view "$ISSUE_NUMBER" --json headRefOid --jq '.headRefOid' > /dev/null 2>&1; then
            head_sha=$(gh pr view "$ISSUE_NUMBER" --json headRefOid --jq '.headRefOid')
            echo "head_sha=$head_sha" >> "$GITHUB_OUTPUT"
            echo "is_pr=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_pr=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Capture request text
        id: capture_request
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
          REVIEW_BODY: ${{ github.event.review.body }}
        run: |
          request="$COMMENT_BODY$REVIEW_BODY"
          delim=$(openssl rand -hex 16)
          {
            echo "request<<$delim"
            echo "$request"
            echo "$delim"
          } >> "$GITHUB_OUTPUT"

      - name: Add eyes reaction and post working comment
        id: working_comment
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          ISSUE_NUM: ${{ env.ISSUE_NUMBER }}
          COMMENT_ID: ${{ github.event.comment.id }}
          REVIEW_ID: ${{ github.event.review.id }}
        with:
          github-token: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
          script: |
            const issueNumber = Number(process.env.ISSUE_NUM);
            const commentId = process.env.COMMENT_ID;
            const reviewId = process.env.REVIEW_ID;

            // Add eyes reaction to the triggering comment/review
            if (commentId) {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: Number(commentId),
                content: 'eyes'
              });
            }

            // Post working comment
            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: '> ðŸ¤– **Codex** is working on this...\n\n<img src="https://github.githubassets.com/images/mona-loading-default.gif" width="32" alt="Loading" />'
            });
            return comment.id;
          result-encoding: string

      - name: Run Codex
        id: run_codex
        uses: openai/codex-action@086169432f1d2ab2f4057540b1754d550f6a1189 # v1.4
        env:
          REQUEST: ${{ steps.capture_request.outputs.request }}
          IS_PR: ${{ steps.pr_info.outputs.is_pr }}
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          sandbox: read-only
          output-file: codex-output.json
          output-schema: |
            {
              "type": "object",
              "additionalProperties": false,
              "properties": {
                "response": {"type": "string"},
                "is_code_review": {"type": "boolean"},
                "findings": {
                  "type": "array",
                  "items": {
                    "type": "object",
                    "additionalProperties": false,
                    "properties": {
                      "title": {"type": "string"},
                      "body": {"type": "string"},
                      "priority": {"type": "integer"},
                      "code_location": {
                        "type": "object",
                        "additionalProperties": false,
                        "properties": {
                          "file_path": {"type": "string"},
                          "line_range": {
                            "type": "object",
                            "additionalProperties": false,
                            "properties": {
                              "start": {"type": "integer"},
                              "end": {"type": "integer"}
                            },
                            "required": ["start", "end"]
                          }
                        },
                        "required": ["file_path", "line_range"]
                      }
                    },
                    "required": ["title", "body", "priority", "code_location"]
                  }
                }
              },
              "required": ["response", "is_code_review", "findings"]
            }
          prompt: |
            You are Codex acting as a GitHub assistant for repository ${{ env.REPOSITORY }}.
            A user (@${{ env.ACTOR }}) requested help via ${{ env.EVENT_NAME }}.

            Use `gh issue view ${{ env.ISSUE_NUMBER }}` or `gh pr view ${{ env.ISSUE_NUMBER }}` to get context.

            If this is a code review request (user asks to review code/PR/changes):
            - Set is_code_review to true
            - Use `gh pr diff` to see the changes
            - For each issue found, add to the findings array with file_path and line_range
            - Focus on significant issues: bugs, security, performance. Skip style nitpicks.
            - Put a summary in the response field

            If this is NOT a code review (question, help request, etc.):
            - Set is_code_review to false
            - Put your full response in the response field
            - Leave findings as an empty array

            Always respond concisely. Use Markdown.

      - name: Post response
        if: always() && steps.run_codex.outcome == 'success'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          HEAD_SHA: ${{ steps.pr_info.outputs.head_sha }}
          IS_PR: ${{ steps.pr_info.outputs.is_pr }}
          WORKING_COMMENT_ID: ${{ steps.working_comment.outputs.result }}
          TRIGGER_COMMENT_ID: ${{ github.event.comment.id }}
        with:
          github-token: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
          script: |
            const fs = require('fs');
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            const headSha = process.env.HEAD_SHA;
            const isPR = process.env.IS_PR === 'true';
            const workingCommentId = process.env.WORKING_COMMENT_ID;
            const triggerCommentId = process.env.TRIGGER_COMMENT_ID;

            // Helper to clean up working comment
            async function cleanupWorkingComment() {
              if (workingCommentId) {
                try {
                  await github.rest.issues.deleteComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: Number(workingCommentId)
                  });
                } catch (err) {
                  core.warning(`Failed to delete working comment: ${err.message}`);
                }
              }
              // Remove eyes reaction from trigger comment
              if (triggerCommentId) {
                try {
                  const reactions = await github.rest.reactions.listForIssueComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: Number(triggerCommentId)
                  });
                  const eyesReaction = reactions.data.find(r => r.content === 'eyes' && r.user?.login?.includes('[bot]'));
                  if (eyesReaction) {
                    await github.rest.reactions.deleteForIssueComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      comment_id: Number(triggerCommentId),
                      reaction_id: eyesReaction.id
                    });
                  }
                } catch (err) {
                  core.warning(`Failed to remove reaction: ${err.message}`);
                }
              }
            }

            // Read Codex output
            let output;
            try {
              const rawOutput = fs.readFileSync('codex-output.json', 'utf8');
              output = JSON.parse(rawOutput);
            } catch (err) {
              core.warning(`Failed to parse Codex output: ${err.message}`);
              await cleanupWorkingComment();
              return;
            }

            if (!output || !output.response) {
              core.warning('No response in Codex output');
              await cleanupWorkingComment();
              return;
            }

            // If it's a code review with findings on a PR, post inline comments
            if (output.is_code_review && isPR && output.findings?.length > 0 && headSha) {
              const comments = output.findings
                .filter(f => f.code_location?.file_path && f.code_location?.line_range)
                .map(f => {
                  const priorityLabels = ['ðŸ”´ P0 Critical', 'ðŸŸ  P1 High', 'ðŸŸ¡ P2 Medium', 'ðŸŸ¢ P3 Low'];
                  const priorityLabel = priorityLabels[f.priority] || `P${f.priority}`;
                  return {
                    path: f.code_location.file_path.replace(/^\//, ''),
                    line: f.code_location.line_range.end,
                    start_line: f.code_location.line_range.start !== f.code_location.line_range.end
                      ? f.code_location.line_range.start
                      : undefined,
                    side: 'RIGHT',
                    body: `**${f.title}** (${priorityLabel})\n\n${f.body}`
                  };
                })
                .filter(c => c.path && c.line);

              if (comments.length > 0) {
                try {
                  const hasCritical = output.findings.some(f => f.priority === 0);
                  await github.rest.pulls.createReview({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: issueNumber,
                    commit_id: headSha,
                    event: hasCritical ? 'REQUEST_CHANGES' : 'COMMENT',
                    body: output.response,
                    comments: comments
                  });
                  core.info(`Posted review with ${comments.length} inline comments`);
                  await cleanupWorkingComment();
                  return;
                } catch (err) {
                  core.warning(`Failed to post inline comments: ${err.message}`);
                  // Fall through to regular comment
                }
              }
            }

            // Post as regular comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: output.response
            });
            await cleanupWorkingComment();

      - name: Cleanup on failure
        if: always() && steps.run_codex.outcome != 'success'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          WORKING_COMMENT_ID: ${{ steps.working_comment.outputs.result }}
          TRIGGER_COMMENT_ID: ${{ github.event.comment.id }}
        with:
          github-token: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
          script: |
            const workingCommentId = process.env.WORKING_COMMENT_ID;
            const triggerCommentId = process.env.TRIGGER_COMMENT_ID;

            // Update working comment to show failure
            if (workingCommentId) {
              try {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: Number(workingCommentId),
                  body: 'âŒ Codex encountered an error while processing your request.'
                });
              } catch (err) {
                core.warning(`Failed to update working comment: ${err.message}`);
              }
            }

            // Remove eyes reaction
            if (triggerCommentId) {
              try {
                const reactions = await github.rest.reactions.listForIssueComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: Number(triggerCommentId)
                });
                const eyesReaction = reactions.data.find(r => r.content === 'eyes' && r.user?.login?.includes('[bot]'));
                if (eyesReaction) {
                  await github.rest.reactions.deleteForIssueComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: Number(triggerCommentId),
                    reaction_id: eyesReaction.id
                  });
                }
              } catch (err) {
                core.warning(`Failed to remove reaction: ${err.message}`);
              }
            }
