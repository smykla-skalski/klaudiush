# Codex Code Review workflow
# Runs Codex on pull requests when explicitly requested

name: Codex Code Review

on:
  # Manual trigger from Actions UI
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number to review"
        required: true
        type: number

  # Comment trigger for "/codex review" command
  issue_comment:
    types: [created]

permissions: {}

jobs:
  check-trigger:
    runs-on: ubuntu-24.04

    permissions:
      pull-requests: read
      issues: read

    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.check.outputs.pr_number }}

    steps:
      - name: Check trigger conditions
        id: check
        env:
          EVENT_NAME: ${{ github.event_name }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          IS_PR_COMMENT: ${{ github.event.issue.pull_request != '' }}
          AUTHOR_ASSOCIATION: ${{ github.event.comment.author_association }}
          PR_NUMBER_INPUT: ${{ inputs.pr_number }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          should_run="false"
              pr_number=""

          case "$EVENT_NAME" in
            workflow_dispatch)
              should_run="true"
              pr_number="$PR_NUMBER_INPUT"
              ;;
            issue_comment)
              if [[ "$IS_PR_COMMENT" == "true" ]] && [[ "$AUTHOR_ASSOCIATION" =~ ^(OWNER|MEMBER|COLLABORATOR)$ ]] && grep -qiE '(^|\n)\s*/codex\s+review\s*($|\n)' <<< "$COMMENT_BODY"; then
                should_run="true"
                pr_number="$ISSUE_NUMBER"
              fi
              ;;
          esac

          echo "should_run=$should_run" >> "$GITHUB_OUTPUT"
          echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"

  codex-review:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-24.04

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Mint identity token
        id: mint_identity_token
        if: vars.SMYKLOT_APP_ID
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        with:
          app-id: ${{ vars.SMYKLOT_APP_ID }}
          private-key: ${{ secrets.SMYKLOT_PRIVATE_KEY }}
          permission-contents: read
          permission-issues: write
          permission-pull-requests: write

      - name: Checkout PR merge commit
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          token: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
          ref: refs/pull/${{ needs.check-trigger.outputs.pr_number }}/merge
          fetch-depth: 0

      - name: Pre-fetch base and head refs for the PR
        env:
          GH_TOKEN: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
          PR_NUMBER: ${{ needs.check-trigger.outputs.pr_number }}
        run: |
          gh pr view "$PR_NUMBER" --json baseRefName,headRefName --template '{{.baseRefName}} {{.headRefName}}' | read base head
          git fetch --no-tags origin "$base" "+refs/pull/${PR_NUMBER}/head:refs/remotes/origin/pull/${PR_NUMBER}/head"

      - name: Run Codex review
        id: run_codex
        uses: openai/codex-action@086169432f1d2ab2f4057540b1754d550f6a1189 # v1.4
        env:
          PR_NUMBER: ${{ needs.check-trigger.outputs.pr_number }}
          REPOSITORY: ${{ github.repository }}
          PR_TITLE: ${{ github.event.pull_request.title || github.event.issue.title }}
          PR_BODY: ${{ github.event.pull_request.body || github.event.issue.body }}
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          sandbox: read-only
          prompt: |
            You are Codex performing a concise code review for PR #${{ env.PR_NUMBER }} in ${{ env.REPOSITORY }}.

            Focus only on significant issues: correctness, security, performance, data races, and maintainability. Skip minor style nitpicks.
            When you reference code, cite file paths and line numbers from the diff when possible.

            Pull request title: ${{ env.PR_TITLE }}
            Pull request body:
            ---
            ${{ env.PR_BODY }}

            Output a short review suitable for posting as a single PR comment. Use markdown bullets.

      - name: Post Codex review comment
        if: steps.run_codex.outputs.final-message != ''
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          CODEX_FINAL_MESSAGE: ${{ steps.run_codex.outputs['final-message'] }}
          PR_NUMBER: ${{ needs.check-trigger.outputs.pr_number }}
        with:
          github-token: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            const body = process.env.CODEX_FINAL_MESSAGE;

            if (!body || !prNumber) {
              core.warning('No final message or PR number; skipping comment.');
              return;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            });
