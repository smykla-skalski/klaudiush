# Claude Code Review workflow
# Reviews pull requests using Claude - triggered on demand, not automatically
#
# Triggers:
#   - Manual: workflow_dispatch from Actions UI
#   - Comment: "/claude review" command on a PR
#   - Label: Adding "auto-review" label to a PR
#   - Ready: PR transitions from draft to ready for review

name: Claude Code Review

on:
  # Manual trigger from Actions UI
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number to review"
        required: true
        type: number

  # Comment trigger for "/claude review" command
  issue_comment:
    types: [created]

  # Label trigger when "auto-review" label is added
  pull_request:
    types: [labeled, ready_for_review]

permissions: {}

jobs:
  # Determine if review should run and extract PR number
  check-trigger:
    runs-on: ubuntu-24.04

    permissions:
      pull-requests: read
      issues: read

    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.check.outputs.pr_number }}

    steps:
      - name: Check trigger conditions
        id: check
        env:
          EVENT_NAME: ${{ github.event_name }}
          EVENT_ACTION: ${{ github.event.action }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          IS_PR_COMMENT: ${{ github.event.issue.pull_request != '' }}
          LABEL_NAME: ${{ github.event.label.name }}
          PR_NUMBER_INPUT: ${{ inputs.pr_number }}
          PR_NUMBER_EVENT: ${{ github.event.pull_request.number }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          should_run="false"
          pr_number=""

          case "$EVENT_NAME" in
            workflow_dispatch)
              should_run="true"
              pr_number="$PR_NUMBER_INPUT"
              echo "Triggered via manual workflow dispatch for PR #$pr_number"
              ;;
            issue_comment)
              # Check if comment is on a PR and contains "/claude review" command
              # Pattern requires start-of-line or whitespace before command, word boundary after
              if [[ "$IS_PR_COMMENT" == "true" ]] && grep -qiE '(^|\s)/claude\s+review\b' <<< "$COMMENT_BODY"; then
                should_run="true"
                pr_number="$ISSUE_NUMBER"
                echo "Triggered via /claude review command on PR #$pr_number"
              fi
              ;;
            pull_request)
              pr_number="$PR_NUMBER_EVENT"
              # Check if labeled with "auto-review"
              if [[ "$LABEL_NAME" == "auto-review" ]]; then
                should_run="true"
                echo "Triggered via auto-review label on PR #$pr_number"
              # Check if PR transitioned from draft to ready (event only fires on transition)
              elif [[ "$EVENT_ACTION" == "ready_for_review" ]]; then
                should_run="true"
                echo "Triggered via draft-to-ready transition on PR #$pr_number"
              fi
              ;;
          esac

          echo "should_run=$should_run" >> "$GITHUB_OUTPUT"
          echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"

  claude-review:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-24.04

    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@a7e4c51380c42dd89b127f5e5f9be7b54020bc6b # v1.0.21
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Review PR #${{ needs.check-trigger.outputs.pr_number }} in ${{ github.repository }}.

            Focus on significant issues only: bugs, security problems, or major quality concerns.
            Skip minor style nitpicks. Follow CLAUDE.md conventions. Be concise.

            Post your review using `gh pr comment`.
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
