# Claude Code Review workflow
# Reviews pull requests using Claude - only runs when explicitly requested
# Posts inline review comments on specific lines in the diff
#
# Triggers:
#   - Manual: workflow_dispatch from Actions UI
#   - Comment: "/claude review" command on a PR (collaborators only)

name: Claude Code Review

on:
  # Manual trigger from Actions UI
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number to review"
        required: true
        type: number

  # Comment trigger for "/claude review" command
  issue_comment:
    types: [created]

permissions: {}

jobs:
  # Determine if review should run and extract PR number
  check-trigger:
    runs-on: ubuntu-24.04

    permissions:
      pull-requests: read
      issues: read

    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      pr_number: ${{ steps.check.outputs.pr_number }}

    steps:
      - name: Check trigger conditions
        id: check
        env:
          EVENT_NAME: ${{ github.event_name }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          IS_PR_COMMENT: ${{ github.event.issue.pull_request != '' }}
          AUTHOR_ASSOCIATION: ${{ github.event.comment.author_association }}
          PR_NUMBER_INPUT: ${{ inputs.pr_number }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          should_run="false"
          pr_number=""

          case "$EVENT_NAME" in
            workflow_dispatch)
              should_run="true"
              pr_number="$PR_NUMBER_INPUT"
              echo "Triggered via manual workflow dispatch for PR #$pr_number"
              ;;
            issue_comment)
              # Check if comment is on a PR, by a collaborator, and contains "/claude review"
              if [[ "$IS_PR_COMMENT" == "true" ]] && [[ "$AUTHOR_ASSOCIATION" =~ ^(OWNER|MEMBER|COLLABORATOR)$ ]] && grep -qiE '(^|\n)\s*/claude\s+review\s*($|\n)' <<< "$COMMENT_BODY"; then
                should_run="true"
                pr_number="$ISSUE_NUMBER"
                echo "Triggered via /claude review command on PR #$pr_number"
              fi
              ;;
          esac

          echo "should_run=$should_run" >> "$GITHUB_OUTPUT"
          echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"

  claude-review:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-24.04

    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    env:
      PR_NUMBER: ${{ needs.check-trigger.outputs.pr_number }}
      REPOSITORY: ${{ github.repository }}

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@6337623ebba10cf8c8214b507993f8062fd4ccfb # v1.0.22
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are reviewing PR #${{ env.PR_NUMBER }} in ${{ env.REPOSITORY }}.

            First, use `gh pr diff ${{ env.PR_NUMBER }}` to see the changes.

            Focus on significant issues only: bugs, security problems, performance issues, or major quality concerns.
            Skip minor style nitpicks. Follow CLAUDE.md conventions. Be concise.

            For each issue you find:
            1. Use `mcp__github_inline_comment__create_inline_comment` to post an inline comment on the specific line in the diff
            2. Include a clear title and explanation of the issue
            3. Suggest how to fix it

            After reviewing all files, post a summary comment using `gh pr comment ${{ env.PR_NUMBER }} --body "..."` with:
            - Overall assessment (looks good / needs changes)
            - Count of issues found
            - Any general recommendations
          claude_args: '--allowed-tools "mcp__github_inline_comment__*,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
