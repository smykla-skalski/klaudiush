# Updates nix/package.nix vendorHash when Go dependencies change
# Runs on PRs that modify go.mod or go.sum

name: Update Nix vendorHash

on:
  pull_request:
    paths:
      - 'go.mod'
      - 'go.sum'

permissions: {}

jobs:
  update-vendor-hash:
    name: Update vendorHash
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ vars.SMYKLOT_APP_ID }}
          private-key: ${{ secrets.SMYKLOT_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.head_ref }}
          token: ${{ steps.app-token.outputs.token }}

      - name: Install Nix
        uses: cachix/install-nix-action@0b0e072294b088b73964f1d72dfdac0951439dbd # v31.8.4
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Calculate new vendorHash
        id: calc-hash
        run: |
          # Build with fake hash to get the correct one
          cd nix
          OUTPUT=$(nix build .#klaudiush --no-write-lock-file 2>&1 || true)
          NEW_HASH=$(echo "$OUTPUT" | grep -oP 'got:\s+\Ksha256-[A-Za-z0-9+/=]+' || echo "")

          if [ -z "$NEW_HASH" ]; then
            echo "Build succeeded or no hash mismatch found"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "New vendorHash: $NEW_HASH"
            echo "new_hash=$NEW_HASH" >> "$GITHUB_OUTPUT"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Update package.nix
        if: steps.calc-hash.outputs.changed == 'true'
        env:
          NEW_HASH: ${{ steps.calc-hash.outputs.new_hash }}
        run: |
          sed -i "s|vendorHash = \"sha256-[^\"]*\";|vendorHash = \"$NEW_HASH\";|" nix/package.nix
          echo "Updated nix/package.nix with new vendorHash"

      - name: Verify build
        if: steps.calc-hash.outputs.changed == 'true'
        run: |
          cd nix
          nix build .#klaudiush --no-write-lock-file

      - name: Commit changes
        if: steps.calc-hash.outputs.changed == 'true'
        env:
          NEW_HASH: ${{ steps.calc-hash.outputs.new_hash }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          HEAD_REF: ${{ github.head_ref }}
        run: |
          # Extract short hash (first 12 chars after sha256-)
          SHORT_HASH=$(echo "$NEW_HASH" | sed 's/sha256-//' | cut -c1-12)
          COMMIT_MSG="build(nix): update vendorHash to ${SHORT_HASH}"

          # Get current file SHA from local git (blob SHA from index)
          FILE_SHA=$(git ls-files -s nix/package.nix | awk '{print $2}')

          # Base64 encode the updated file content
          CONTENT=$(base64 -w 0 nix/package.nix)

          # Update file via GitHub API (creates verified commit)
          gh api "repos/${GITHUB_REPOSITORY}/contents/nix/package.nix" \
            --method PUT \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -f message="$COMMIT_MSG" \
            -f content="$CONTENT" \
            -f sha="$FILE_SHA" \
            -f branch="$HEAD_REF"
