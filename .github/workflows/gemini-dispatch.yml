# Gemini CLI dispatcher workflow
# Routes @gemini mentions to appropriate handlers (review, triage, invoke)

name: Gemini Dispatch

on:
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

permissions: {}

defaults:
  run:
    shell: bash

jobs:
  debugger:
    if: fromJSON(vars.DEBUG || vars.ACTIONS_STEP_DEBUG || false)
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - name: Print context for debugging
        env:
          DEBUG_event_name: ${{ github.event_name }}
          DEBUG_event__action: ${{ github.event.action }}
          DEBUG_event__comment__author_association: ${{ github.event.comment.author_association }}
          DEBUG_event__issue__author_association: ${{ github.event.issue.author_association }}
          DEBUG_event__pull_request__author_association: ${{ github.event.pull_request.author_association }}
          DEBUG_event__review__author_association: ${{ github.event.review.author_association }}
          DEBUG_event: ${{ toJSON(github.event) }}
        run: |
          env | grep '^DEBUG_'

  dispatch:
    # Only if user types @gemini and is OWNER/MEMBER/COLLABORATOR
    if: |
      github.event.sender.type == 'User' &&
      startsWith(github.event.comment.body || github.event.review.body, '@gemini') &&
      contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association || github.event.review.author_association)
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      issues: write
      pull-requests: write
    outputs:
      command: ${{ steps.extract_command.outputs.command }}
      request: ${{ steps.extract_command.outputs.request }}
      additional_context: ${{ steps.extract_command.outputs.additional_context }}
      issue_number: ${{ github.event.pull_request.number || github.event.issue.number }}
      working_comment_id: ${{ steps.acknowledge.outputs.comment_id }}
    steps:
      - name: Mint identity token
        id: mint_identity_token
        if: vars.GEMINI_APP_ID
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        with:
          app-id: ${{ vars.GEMINI_APP_ID }}
          private-key: ${{ secrets.GEMINI_PRIVATE_KEY }}
          permission-contents: read
          permission-issues: write
          permission-pull-requests: write

      - name: Extract command
        id: extract_command
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          REQUEST: ${{ github.event.comment.body || github.event.review.body }}
        with:
          script: |
            const request = process.env.REQUEST;
            core.setOutput('request', request);

            if (request.startsWith("@gemini /review")) {
              core.setOutput('command', 'review');
              const additionalContext = request.replace(/^@gemini \/review/, '').trim();
              core.setOutput('additional_context', additionalContext);
            } else if (request.startsWith("@gemini /triage")) {
              core.setOutput('command', 'triage');
            } else if (request.startsWith("@gemini")) {
              const additionalContext = request.replace(/^@gemini/, '').trim();
              core.setOutput('command', 'invoke');
              core.setOutput('additional_context', additionalContext);
            } else {
              core.setOutput('command', 'fallthrough');
            }

      - name: Acknowledge request
        id: acknowledge
        env:
          GITHUB_TOKEN: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
          ISSUE_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
          ACTOR: ${{ github.actor }}
          LOGS_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          REPOSITORY: ${{ github.repository }}
        run: |
          MESSAGE="ðŸ¤– Hi @${ACTOR}, I've received your request, and I'm working on it now! You can track my progress [in the logs](${LOGS_URL}) for more details."
          COMMENT_URL=$(gh issue comment "${ISSUE_NUMBER}" \
            --body "${MESSAGE}" \
            --repo "${REPOSITORY}")
          # Extract comment ID from URL (format: https://github.com/owner/repo/issues/N#issuecomment-ID)
          COMMENT_ID=$(echo "${COMMENT_URL}" | grep -oE 'issuecomment-[0-9]+' | cut -d'-' -f2)
          echo "comment_id=${COMMENT_ID}" >> "$GITHUB_OUTPUT"

  review:
    needs: dispatch
    if: needs.dispatch.outputs.command == 'review'
    uses: ./.github/workflows/gemini-review.yml
    permissions:
      contents: read
      id-token: write
      issues: write
      pull-requests: write
    with:
      additional_context: ${{ needs.dispatch.outputs.additional_context }}
    secrets: inherit

  triage:
    needs: dispatch
    if: needs.dispatch.outputs.command == 'triage'
    uses: ./.github/workflows/gemini-triage.yml
    permissions:
      contents: read
      id-token: write
      issues: write
      pull-requests: write
    with:
      additional_context: ${{ needs.dispatch.outputs.additional_context }}
    secrets: inherit

  invoke:
    needs: dispatch
    if: needs.dispatch.outputs.command == 'invoke'
    uses: ./.github/workflows/gemini-invoke.yml
    permissions:
      contents: write
      id-token: write
      issues: write
      pull-requests: write
    with:
      additional_context: ${{ needs.dispatch.outputs.additional_context }}
    secrets: inherit

  cleanup:
    needs: [dispatch, review, triage, invoke]
    if: always() && !cancelled() && !failure() && needs.dispatch.outputs.working_comment_id
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Mint identity token
        id: mint_identity_token
        if: vars.GEMINI_APP_ID
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        with:
          app-id: ${{ vars.GEMINI_APP_ID }}
          private-key: ${{ secrets.GEMINI_PRIVATE_KEY }}
          permission-issues: write
          permission-pull-requests: write

      - name: Delete working comment
        env:
          GITHUB_TOKEN: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
          COMMENT_ID: ${{ needs.dispatch.outputs.working_comment_id }}
          REPOSITORY: ${{ github.repository }}
        run: |
          gh api "repos/${REPOSITORY}/issues/comments/${COMMENT_ID}" -X DELETE || true

  fallthrough:
    needs: [dispatch, review, triage, invoke]
    if: always() && !cancelled() && (failure() || needs.dispatch.outputs.command == 'fallthrough')
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Mint identity token
        id: mint_identity_token
        if: vars.GEMINI_APP_ID
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        with:
          app-id: ${{ vars.GEMINI_APP_ID }}
          private-key: ${{ secrets.GEMINI_PRIVATE_KEY }}
          permission-contents: read
          permission-issues: write
          permission-pull-requests: write

      - name: Update working comment with failure
        env:
          GITHUB_TOKEN: ${{ steps.mint_identity_token.outputs.token || secrets.GITHUB_TOKEN || github.token }}
          COMMENT_ID: ${{ needs.dispatch.outputs.working_comment_id }}
          ISSUE_NUMBER: ${{ github.event.pull_request.number || github.event.issue.number }}
          ACTOR: ${{ github.actor }}
          LOGS_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          REPOSITORY: ${{ github.repository }}
        run: |
          MESSAGE="ðŸ¤– I'm sorry @${ACTOR}, but I was unable to process your request. Please [see the logs](${LOGS_URL}) for more details."
          if [[ -n "${COMMENT_ID}" ]]; then
            gh api "repos/${REPOSITORY}/issues/comments/${COMMENT_ID}" \
              -X PATCH \
              -f body="${MESSAGE}" || \
            gh issue comment "${ISSUE_NUMBER}" --body "${MESSAGE}" --repo "${REPOSITORY}"
          else
            gh issue comment "${ISSUE_NUMBER}" --body "${MESSAGE}" --repo "${REPOSITORY}"
          fi
